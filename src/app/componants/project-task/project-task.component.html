<div class="container">
  <div *ngFor="let group of groupedTasks; let i = index">

    <!-- Actions -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5>{{ 'Related Tasks' | translate }}</h5>
      <button class="btn btn-outline-success btn-sm" (click)="openModal()">
        <i class="fas fa-plus"></i> {{ 'add task' | translate }}
      </button>
    </div>

    <!-- Tableau -->
    <div class="card shadow-sm mb-4">
      <!-- Ajout du sélecteur d'éléments par page -->
      <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
        <div class="d-flex align-items-center">
          <label class="me-2">{{ 'Items per page' | translate }}:</label>
          <select class="form-select form-select-sm" style="width: auto" [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange(i)">
            <option [value]="3">3</option>
            <option [value]="5">5</option>
            <option [value]="10">10</option>
            <option [value]="20">20</option>
            <option [value]="50">50</option>
          </select>
        </div>
        <div class="text-muted">
          {{ 'Showing' | translate }} {{ (group.currentPage - 1) * itemsPerPage + 1 }} - {{ Math.min(group.currentPage * itemsPerPage, group.filteredTasks.length) }} {{ 'of' | translate }} {{ group.filteredTasks.length }} {{ 'items' | translate }}
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover table-bordered mb-0">
          <thead class="table-light">
            <tr>
              <th rowspan="2" class="align-middle">{{ 'ID' | translate }}</th>
              <th rowspan="2" class="align-middle">{{ 'Task name' | translate }}</th>
              <th rowspan="2" class="align-middle">{{ 'Description' | translate }}</th>
              <th rowspan="2" class="align-middle">{{ 'Members' | translate }}</th>
              <th rowspan="2" class="align-middle">{{ 'Status' | translate }}</th>
              <th rowspan="2" class="align-middle">{{ 'Member Progress' | translate }}</th>
              <th colspan="2" class="text-center">{{ 'Estimated dates' | translate }}</th>
              <th colspan="2" class="text-center">{{ 'Effective dates' | translate }}</th>
              <th colspan="3" class="text-center">MD</th>
              <th rowspan="2" class="align-middle text-center">{{ 'Actions' | translate }}</th>
            </tr>
            <tr>
              <th>{{ 'Start date' | translate }}</th>
              <th>{{ 'End date' | translate }}</th>
              <th>{{ 'Start date' | translate }}</th>
              <th>{{ 'End date' | translate }}</th>
              <th>{{ 'Worked' | translate }}</th>
              <th>{{ 'Estimated' | translate }}</th>
              <th>{{ 'Remaining' | translate }}</th>
            </tr>
          </thead>

          <tbody>
            <ng-container
              *ngFor="let task of group.filteredTasks | paginate:{ itemsPerPage: itemsPerPage, currentPage: group.currentPage, id: 'pagination_' + i }; let taskIndex = index">

              <!-- Cas sans assignation -->
              <tr *ngIf="task.assignments.length === 0" [ngClass]="{'bg-light': taskIndex % 2 === 0}">
                <td>{{ task.id }}</td>
                <td>{{ task.name }}</td>
                <td>{{ task.description }}</td>
                <td colspan="10" class="text-center text-muted fst-italic">
                  {{ 'no member assigned' | translate }}
                </td>

                <td class="text-center">
                  <button class="btn btn-outline-success btn-sm me-2" (click)="openModal(task)">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-outline-info btn-sm me-2" (click)="openDetailsModal(task)">
                    <i class="fas fa-info-circle"></i>
                  </button>
                  <button class="btn btn-outline-danger btn-sm" (click)="deleteTask(task.id!)">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>

              <!-- Cas avec assignations -->
              <ng-container *ngFor="let a of task.assignments; let j = index">
                <tr [ngClass]="{'bg-light': taskIndex % 2 === 0}" [attr.data-new-task]="j === 0 ? 'true' : 'false'">
                  <td *ngIf="j === 0" [attr.rowspan]="task.assignments.length" class="align-middle">{{ task.id }}</td>
                  <td *ngIf="j === 0" [attr.rowspan]="task.assignments.length" class="align-middle">{{ task.name }}</td>
                  <td *ngIf="j === 0" [attr.rowspan]="task.assignments.length" class="align-middle">{{ task.description
                    }}</td>
                  <td>{{ getMemberName(a.teamMemberId) }}</td>
                  <td *ngIf="j === 0" [attr.rowspan]="task.assignments.length" class="align-middle">
                    <span class="badge rounded-pill" [ngClass]="{
                      'bg-secondary': task.status === 'TODO',
                      'bg-primary': task.status === 'IN_PROGRESS',
                      'bg-warning text-dark': task.status === 'DONE',
                      'bg-danger': task.status === 'BLOCKED'
                    }">{{ getStatusLabel(task.status) }}</span>
                  </td>
                  <td>
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar" role="progressbar" [style.width]="a.progress + '%'" [ngClass]="{
                             'bg-danger': a.progress < 25,
                             'bg-warning': a.progress >= 25 && a.progress < 50,
                             'bg-info': a.progress >= 50 && a.progress < 75,
                             'bg-success': a.progress >= 75
                           }" aria-valuenow="a.progress" aria-valuemin="0" aria-valuemax="100">{{a.progress}}%</div>
                    </div>
                  </td>

                  <td>{{ a.estimatedStartDate | date:'dd/MM/yyyy' }}</td>
                  <td>{{ a.estimatedEndDate | date:'dd/MM/yyyy' }}</td>
                  <td>{{ a.effectiveStartDate | date:'dd/MM/yyyy' }}</td>
                  <td>{{ a.effectiveEndDate | date:'dd/MM/yyyy' }}</td>

                  <td>{{ a.workedMD }}</td>
                  <td>{{ a.estimatedMD }}</td>
                  <td>{{ a.remainingMD }}</td>
                  <td *ngIf="j === 0" [attr.rowspan]="task.assignments.length" class="text-center align-middle">
                    <button class="btn btn-outline-success btn-sm me-2" (click)="openModal(task)">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-info btn-sm me-2" (click)="openDetailsModal(task)">
                      <i class="fas fa-info-circle"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" (click)="deleteTask(task.id!)">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              </ng-container>

            </ng-container>

            <!-- Aucun résultat -->
            <tr *ngIf="group.filteredTasks.length === 0">
              <td colspan="14" class="text-center text-muted fst-italic py-4">{{ 'no task found' | translate }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination en bas -->
    <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
      <div class="text-muted">
        {{ 'Page' | translate }} {{ group.currentPage }} {{ 'of' | translate }} {{ Math.ceil(group.filteredTasks.length / itemsPerPage) }}
      </div>
      <pagination-controls 
        id="pagination_{{ i }}" 
        (pageChange)="onPageChange(i, $event)" 
        [autoHide]="false"
        [maxSize]="5"
        [directionLinks]="true"
        previousLabel="« {{ 'Previous' | translate }}"
        nextLabel="{{ 'Next' | translate }} »">
      </pagination-controls>
    </div>

  </div>
</div>
<div class="modal fade" id="taskModal" tabindex="-1" aria-labelledby="taskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="taskModalLabel">
          {{ selectedTask.id ? ('edit task' | translate) : ('add task' | translate) }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModal()" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label>{{ 'Task name' | translate }}</label>
          <input class="form-control" [(ngModel)]="selectedTask.name">
        </div>

        <div class="mb-3">
          <label>{{ 'Description' | translate }}</label>
          <textarea class="form-control" [(ngModel)]="selectedTask.description"></textarea>
        </div>

        <div class="mb-3">
          <label>{{ 'Status' | translate }}</label>
          <select class="form-select" [(ngModel)]="selectedTask.status">
            <option *ngFor="let s of statusList" [ngValue]="s">{{ getStatusLabel(s) }}</option>
          </select>
        </div>
        <div class="mb-3">
          <label>{{ 'Start date' | translate }}</label>
          <input type="date" class="form-control" [(ngModel)]="selectedTask.dateDebut">
        </div>

        <div class="mb-3">
          <label>{{ 'End date' | translate }}</label>
          <input type="date" class="form-control" [(ngModel)]="selectedTask.dateFin">
        </div>

        <div class="mb-3">
          <label class="fw-bold">{{ 'Assignments' | translate }}</label>

          <div *ngFor="let assignment of selectedTask.assignments; let j = index"
            class="assignment-box mb-4 p-3 border rounded shadow-sm bg-light">

            <div class="mb-3">
              <label>{{ 'Team member' | translate }}</label>
              <select class="form-select" [(ngModel)]="assignment.teamMemberId">
                <option [ngValue]="null">-- {{ 'select member' | translate }} --</option>
                <option *ngFor="let m of filteredMembers" [ngValue]="m.id">{{ m.name }}</option>
              </select>
            </div>

            <div class="mb-3">
              <label>{{ 'Estimated start date' | translate }}</label>
              <input type="date" class="form-control" [(ngModel)]="assignment.estimatedStartDate">
            </div>

            <div class="mb-3">
              <label>{{ 'Estimated end date' | translate }}</label>
              <input type="date" class="form-control" [(ngModel)]="assignment.estimatedEndDate">
            </div>

            <div class="text-end mt-2">
              <button class="btn btn-outline-danger btn-sm" (click)="selectedTask.assignments.splice(j, 1)">
                <i class="fas fa-trash-alt"></i> {{ 'delete' | translate }}
              </button>
            </div>

          </div>

          <div class="text-center">
            <button class="btn btn-outline-success btn-sm"
              (click)="selectedTask.assignments.push({ teamMemberId: null, progress: 0, estimatedMD: 0, workedMD: 0, estimatedStartDate: '', estimatedEndDate: '' })">
              + {{ 'add member' | translate }}
            </button>
          </div>

        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary me-2" (click)="closeModal()">{{ 'cancel' | translate }}</button>
        <button class="btn btn-primary" (click)="saveTask()">{{ 'save' | translate }}</button>
      </div>

    </div>
  </div>
</div>

<!-- Nouvelle modal pour afficher les détails -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailsModalLabel">
          {{ 'task details' | translate }}: {{ selectedTaskDetails?.name }}
        </h5>
        <button type="button" class="btn-close" (click)="closeDetailsModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Informations générales de la tâche -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="mb-2"><strong>{{ 'ID' | translate }}:</strong> {{ selectedTaskDetails?.id }}</div>
            <div class="mb-2"><strong>{{ 'Task name' | translate }}:</strong> {{ selectedTaskDetails?.name }}</div>
            <div class="mb-2"><strong>{{ 'Description' | translate }}:</strong> {{ selectedTaskDetails?.description }}
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-2">
              <strong>{{ 'Status' | translate }}:</strong>
              <span class="badge rounded-pill ms-2" [ngClass]="{
                'bg-secondary': selectedTaskDetails?.status === 'TODO',
                'bg-primary': selectedTaskDetails?.status === 'IN_PROGRESS',
                'bg-warning text-dark': selectedTaskDetails?.status === 'DONE',
                'bg-danger': selectedTaskDetails?.status === 'BLOCKED'
              }">{{ getStatusLabel(selectedTaskDetails?.status || 'TODO') }}</span>
            </div>
            <div class="mb-2"><strong>{{ 'Start date' | translate }}:</strong> {{ selectedTaskDetails?.dateDebut |
              date:'dd/MM/yyyy' }}</div>
            <div class="mb-2"><strong>{{ 'End date' | translate }}:</strong> {{ selectedTaskDetails?.dateFin |
              date:'dd/MM/yyyy' }}</div>
          </div>
        </div>

        <!-- Calendrier de travail par membre -->
        <h5 class="border-bottom pb-2 mb-4">{{ 'Work Calendar' | translate }}</h5>

        <div *ngFor="let a of selectedTaskDetails?.assignments || []; let i = index" class="mb-4 pb-3 border-bottom">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">{{ getMemberName(a.teamMemberId) }}</h6>
            <div>
              <span class="badge bg-success me-2">{{ 'Estimated' | translate }}: {{ a.estimatedStartDate |
                date:'dd/MM/yyyy' }} - {{ a.estimatedEndDate | date:'dd/MM/yyyy' }}</span>
              <button class="btn btn-sm btn-outline-primary" (click)="openWorkDayModal(a)">
                {{ 'Add Work Entry' | translate }}
              </button>
            </div>
          </div>

          <!-- Calendrier -->
          <div class="calendar-container">
            <table class="table table-sm table-bordered calendar-table">
              <thead class="table-light">
                <tr>
                  <th *ngFor="let day of getAllWorkedDays(a)" class="text-center">
                    {{ day | date:'dd/MM' }}<br>
                    <small>{{ day | date:'EEE' }}</small>
                  </th>
                </tr>
              </thead>
              <!-- ======= HTML Angular Template corrigé ======= -->
              <tbody>
                <tr>
                  <td *ngFor="let day of getAllWorkedDays(a)" class="text-center py-3" [ngClass]="{
                    'border border-primary': getMemberWorkStatus(a.teamMemberId, day) === 0,
                    'bg-warning bg-opacity-25': getMemberWorkStatus(a.teamMemberId, day) === 0.5,
                    'bg-info bg-opacity-25': getMemberWorkStatus(a.teamMemberId, day) === 0.25,
                    'bg-primary bg-opacity-25': getMemberWorkStatus(a.teamMemberId, day) === 0.75,
                   ' bg-success bg-opacity-25': getMemberWorkStatus(a.teamMemberId, day) === 1,
                    'bg-danger bg-opacity-25 ': getMemberWorkStatus(a.teamMemberId, day) > 1,
                    'border border-btn-outline-info': isOutOfEstimatedRange(day, a.estimatedStartDate, a.estimatedEndDate)
                  }">
                    {{ getMemberWorkStatus(a.teamMemberId, day) }}
                  </td>

                  <!-- Ajout manuel hors estimation -->
                  <td class="text-center py-3">
                    <button class="btn btn-outline-primary btn-sm" (click)="addWorkDayOutsideRange(a)">
                      <i class="fas fa-plus"></i>
                    </button>
                  </td>
                </tr>
              </tbody>


            </table>
          </div>

          <!-- Légende du calendrier -->
          <div class="d-flex justify-content-end mt-2">
            <span class="me-3"><i class="fas fa-check-circle text-success"></i> {{ 'Full day' | translate }}</span>
            <span class="me-3"><i class="fas fa-adjust text-warning"></i> {{ 'Half day' | translate }}</span>
            <span class="me-3"><i class="fas fa-clock text-info"></i> {{ 'Quarter day' | translate }}</span>
            <span class="me-3"><i class="fas fa-clock text-primary"></i> {{ 'Three quarters' | translate }}</span>
            <span class="me-3"><i class="fas fa-times-circle text-danger"></i> {{ 'Leave' | translate }}</span>
            <span><i class="fas fa-circle text-secondary"></i> {{ 'No data' | translate }}</span>
          </div>

          <!-- Résumé des jours travaillés -->
          <div class="row mt-3">
            <div class="col-md-3">
              <div class="card border-success">
                <div class="card-body text-center py-2">
                  <h6 class="card-title mb-0">{{ 'Full Days' | translate }}</h6>
                  <p class="display-6 mb-0">{{ countMemberWorkDays(a.teamMemberId, 1) }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-warning">
                <div class="card-body text-center py-2">
                  <h6 class="card-title mb-0">{{ 'Half Days' | translate }}</h6>
                  <p class="display-6 mb-0">{{ countMemberWorkDays(a.teamMemberId, 0.5) }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-danger">
                <div class="card-body text-center py-2">
                  <h6 class="card-title mb-0">{{ 'Leave Days' | translate }}</h6>
                  <p class="display-6 mb-0">{{ countMemberWorkDays(a.teamMemberId, 0) }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-primary">
                <div class="card-body text-center py-2">
                  <h6 class="card-title mb-0">{{ 'Total MD' | translate }}</h6>
                  <p class="display-6 mb-0">{{ calculateTotalMD(a.teamMemberId) }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDetailsModal()">{{ 'Close' | translate }}</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal pour ajouter/modifier une entrée de travail -->
<div class="modal fade" id="workDayModal" tabindex="-1" aria-labelledby="workDayModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="workDayModalLabel">{{ 'Work Entry' | translate }}</h5>
        <button type="button" class="btn-close" (click)="closeWorkDayModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label>{{ 'Member' | translate }}</label>
          <input type="text" class="form-control" [value]="getMemberName(selectedAssignment?.teamMemberId)" readonly>
        </div>
        <div class="mb-3">
          <label>{{ 'Date' | translate }}</label>
          <input type="date" class="form-control" [(ngModel)]="selectedWorkDate">
        </div>
        <div class="mb-3">
          <label>{{ 'Work Status' | translate }}</label>
          <input type="number" 
                 class="form-control" 
                 [(ngModel)]="selectedWorkStatus"
                 min="0"
                 max="2"
                 step="0.01"
                 placeholder="Enter work status (0-2)">
        </div>
        <div class="mb-3">
          <label>{{ 'Comment' | translate }}</label>
          <textarea class="form-control" [(ngModel)]="selectedWorkComment" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeWorkDayModal()">{{ 'Cancel' | translate
          }}</button>
        <button type="button" class="btn btn-primary" (click)="saveWorkDay()">{{ 'Save' | translate }}</button>
      </div>
    </div>
  </div>
</div>

<style>
  .calendar-container {
    overflow-x: auto;
  }

  .calendar-table th,
  .calendar-table td {
    min-width: 60px;
    vertical-align: middle;
  }
</style>